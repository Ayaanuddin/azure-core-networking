# This pipeline manually installs Terraform and uses AzureCLI for plan/apply
# to overcome persistent bugs and environment PATH issues.

trigger:
- master

pool:
  # IMPORTANT: If your parallelism grant is not approved, replace 'ubuntu-latest' 
  # with the name of your self-hosted agent pool (e.g., name: 'Default').
  vmImage: 'ubuntu-latest'
  # name: 'Default' # <-- Use this line if using a self-hosted agent

variables:
  # The location where Terraform will store its state file
  backendResourceGroupName: 'rg-terraform-backend'
  backendStorageAccountName: 'tredenceterraformstate'
  backendContainerName: 'tfstate'
  # Naming convention for the deployed infrastructure
  resourceGroupName: 'rg-core-networking-dev'
  location: 'eastus'

stages:
- stage: DeployInfrastructure
  displayName: 'Deploy Core Infrastructure'
  jobs:
  - job: DeployInfrastructure
    displayName: 'Terraform Execution'
    steps:
    
    # 1. Manual Install Terraform 1.4.6
    # This task solves the Bash 127 (command not found) error by
    # ensuring 'terraform' is in the /usr/local/bin PATH.
    - task: Bash@3
      displayName: 'Manual Install Terraform 1.4.6'
      inputs:
        targetType: 'inline'
        script: |
          TERRAFORM_VERSION="1.4.6"
          echo "Installing Terraform version ${TERRAFORM_VERSION} manually..."
          
          # Download the specified version
          curl -o terraform.zip https://releases.hashicorp.com/terraform/${TERRAFORM_VERSION}/terraform_${TERRAFORM_VERSION}_linux_amd64.zip
          
          # Unzip the binary
          unzip terraform.zip
          
          # Move the binary to a directory that is guaranteed to be in the PATH
          # This is the crucial fix for error 127
          sudo mv terraform /usr/local/bin/
          
          # Verification step
          terraform version

    # 2. Terraform Initialization (Init)
    - task: AzureCLI@2
      displayName: 'Terraform Init (Backend Setup)'
      inputs:
        # Service connection name must match the name you created exactly
        connectedServiceNameARM: 'Azure-Tredence-DevOps-ARM' 
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          terraform init \
            -backend-config="resource_group_name=$(backendResourceGroupName)" \
            -backend-config="storage_account_name=$(backendStorageAccountName)" \
            -backend-config="container_name=$(backendContainerName)" \
            -backend-config="key=core-networking-dev.tfstate"

    # 3. Terraform Plan (Using AzureCLI to avoid the CLI task bug)
    - task: AzureCLI@2
      displayName: 'Terraform Plan'
      inputs:
        connectedServiceNameARM: 'Azure-Tredence-DevOps-ARM'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        # The -out flag is key; it creates the plan file
        inlineScript: |
          terraform plan -out=tfplan \
            -var="resource_group_name=$(resourceGroupName)" \
            -var="location=$(location)"
          
          echo "##vso[task.setvariable variable=tfplanFile]$(System.DefaultWorkingDirectory)/tfplan"

    # 4. Terraform Apply (Using AzureCLI to read the plan file)
    - task: AzureCLI@2
      displayName: 'Terraform Apply'
      inputs:
        connectedServiceNameARM: 'Azure-Tredence-DevOps-ARM'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        # Reads the exact plan file created in the previous step
        inlineScript: |
          terraform apply -auto-approve $(System.DefaultWorkingDirectory)/tfplan

    # 5. Clean Up
    - task: Bash@3
      displayName: 'Clean Up Plan File'
      condition: always()
      inputs:
        targetType: 'inline'
        script: |
          # Remove the tfplan file after use
          rm -f tfplan
          echo "tfplan file removed."