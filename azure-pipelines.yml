# azure-pipelines.yml: Azure DevOps Pipeline for Terraform Infrastructure and App Service Deployment

trigger:
  branches:
    include:
      - master # Trigger on changes to the master branch
  paths:
    include:
      - '*.tf'
      - '*.tfvars'
      - azure-pipelines.yml

# VARIABLES: Set your environment and Azure Service Connection details
variables:
  - group: Azure-Terraform-Secrets # Use a variable group for credentials/backend state config
  - name: terraformVersion
    value: '1.4.6' # Specify the desired Terraform version
  - name: azureServiceConnection
    value: 'Azure-Tredence-DevOps-ARM' # This value matches the connection we created

stages:
- stage: IaC_Deployment
  displayName: Terraform Deployment (Init, Plan, Apply)
  jobs:
  - job: DeployInfrastructure
    displayName: Deploy Azure Infrastructure
    pool:
      vmImage: 'ubuntu-latest' # Use a modern Linux agent

    steps:
    # 1. Install Terraform (Version @2)
    - task: TerraformInstaller@2
      displayName: 'Install Terraform $(terraformVersion)'
      inputs:
        terraformVersion: '$(terraformVersion)'

    # 2. Configure Azure Backend (using AzureCLI to perform Init)
    - task: AzureCLI@2
      displayName: 'Terraform Init (Remote State)'
      inputs:
        azureSubscription: '$(azureServiceConnection)'
        scriptType: 'bash'
        scriptLocation: 'inlineScript'
        inlineScript: |
          terraform init \
            -backend-config="resource_group_name=$(BackendResourceGroupName)" \
            -backend-config="storage_account_name=$(BackendStorageAccountName)" \
            -backend-config="container_name=$(BackendContainerName)" \
            -backend-config="key=azure-core-networking.terraform.tfstate"

    # 3. Terraform Validation (Version @2)
    - task: TerraformCLI@2
      displayName: 'Terraform Validate'
      inputs:
        command: 'validate'

    # 4. Terraform Plan
    - task: TerraformCLI@2
      displayName: 'Terraform Plan'
      inputs:
        command: 'plan'
        environmentServiceName: '$(azureServiceConnection)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        planFile: 'tfplan' # Plan file is saved as 'tfplan'

    # 4a. NEW: Publish the plan file as an artifact for reliable sharing
    - task: PublishPipelineArtifact@1
      displayName: 'Publish Terraform Plan Artifact'
      inputs:
        targetPath: '$(System.DefaultWorkingDirectory)/tfplan'
        artifact: 'tfplan'
        publishLocation: 'pipeline'

    # 4b. NEW: Download the plan file artifact before Apply
    - task: DownloadPipelineArtifact@2
      displayName: 'Download Terraform Plan Artifact'
      inputs:
        artifactName: 'tfplan'
        targetPath: '$(System.DefaultWorkingDirectory)'

    # 5. Terraform Apply
    - task: TerraformCLI@2
      displayName: 'Terraform Apply'
      inputs:
        command: 'apply'
        environmentServiceName: '$(azureServiceConnection)'
        workingDirectory: '$(System.DefaultWorkingDirectory)'
        planFile: 'tfplan' # This ensures the apply step finds the plan file from the downloaded artifact
